<!DOCTYPE html>
<html class="writer-html5" lang="pt-br" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A09 - Misturando Python e linguagens compiladas &mdash; cmake-tutorial  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="_static/overrides.css" type="text/css" />
      <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="_static/togglebutton.js"></script>
        <script src="_static/tabs.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Referência rápida" href="quick-reference.html" />
    <link rel="prev" title="A08 - Manipulação de dependência automatizada com FetchContent" href="fetch-content.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> cmake-tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pré-Requisitos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Configurando seu sistema</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Atividades</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="hello-cmake.html">A01 - Dos fontes para os executáveis</a></li>
<li class="toctree-l1"><a class="reference internal" href="cmake-syntax.html">A02 - Síntaxe CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="hello-ctest.html">A03 - Criando e executando testes com o CTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">A04 - Detectando seu ambiente</a></li>
<li class="toctree-l1"><a class="reference internal" href="probing.html">A05 - Compilação, vinculação e execução</a></li>
<li class="toctree-l1"><a class="reference internal" href="targets.html">A06 -Sistemas de compilação baseados em alvos com CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">A07 - Encontrando e usando dependências</a></li>
<li class="toctree-l1"><a class="reference internal" href="fetch-content.html">A08 - Manipulação de dependência automatizada com <code class="docutils literal notranslate"><span class="pre">FetchContent</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">A09 - Misturando Python e linguagens compiladas</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#misturando-c-e-python-com-pybind11">Misturando C++ e Python com pybind11</a></li>
<li class="toctree-l2"><a class="reference internal" href="#misturando-c-fortran-e-python-com-cffi">Misturando C/Fortran e Python com CFFI</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Referências</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quick-reference.html">Referência rápida</a></li>
<li class="toctree-l1"><a class="reference internal" href="zbibliography.html">Bibliografia</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">cmake-tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>A09 - Misturando Python e linguagens compiladas</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/python-bindings.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="a09-misturando-python-e-linguagens-compiladas">
<span id="python-bindings"></span><h1>A09 - Misturando Python e linguagens compiladas<a class="headerlink" href="#a09-misturando-python-e-linguagens-compiladas" title="Permalink to this headline"></a></h1>
<div class="admonition-questao questions admonition" id="questions-0">
<p class="admonition-title">Questão</p>
<ul class="simple">
<li><p>Como podemos lidar com projetos multilinguagens com CMake?</p></li>
</ul>
</div>
<div class="admonition-objetivos objectives admonition" id="objectives-0">
<p class="admonition-title">Objetivos</p>
<ul class="simple">
<li><p>Aprenda a construir ligações Python pybind11.</p></li>
<li><p>Aprenda a construir ligações CFFI Python.</p></li>
</ul>
</div>
<p>Python é uma linguagem de programação dinâmica flexível.
Como o próprio Python é escrito na linguagem de programação C, é possível
escrever módulos de <em>extensão</em> em uma linguagem compilada.
Obtém-se toda a flexibilidade evitando as penalidades de desempenho
inerentes às linguagens interpretadas. Muitos frameworks estão disponíveis
para preencher a lacuna entre linguagens compiladas e
Python. Todos eles contam com alguma forma de geração automática de código:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://swig.org/">SWIG</a>. Possivelmente o framework com a história mais longa.</p></li>
<li><p><a class="reference external" href="https://cffi.readthedocs.io/en/latest/index.html">CFFI</a>. Funciona com C e Fortran.</p></li>
<li><p><a class="reference external" href="https://cython.org/">Cython</a>. Funciona com C e pode exigir muito esforço.</p></li>
</ul>
<section id="misturando-c-e-python-com-pybind11">
<h2>Misturando C++ e Python com pybind11<a class="headerlink" href="#misturando-c-e-python-com-pybind11" title="Permalink to this headline"></a></h2>
<p>Se você está escrevendo C++, você tem ainda mais opções de frameworks de vinculação:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.boost.org/doc/libs/1_75_0/libs/python/doc/html/index.html">Boost.Python</a>.
Adaptado para C++ e conta com metaprogramação de modelo para gerar ligações em tempo de compilação.</p></li>
<li><p><a class="reference external" href="https://pybind11.readthedocs.io/en/stable/index.html">pybind11</a>. Mesma filosofia do Boost.Python, mas projetado para C++11 e além.</p></li>
</ul>
<p>Se você escrever <em>modern C++</em>, pybind11 deve ser sua estrutura de escolha:</p>
<ul class="simple">
<li><p>É uma biblioteca somente de cabeçalho e, portanto, uma dependência bastante fácil de satisfazer.</p></li>
<li><p>O código de ligação será bastante compacto: você não terá que manter uma base de código excessivamente grande.</p></li>
<li><p>Possui excelente integração com o CMake.</p></li>
</ul>
<div class="admonition-exercicio-27-codigo-bancario-com-c-e-python exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercício 27: Código bancário com C++ e Python</p>
<blockquote>
<div><p>Nosso objetivo é compilar wrappers Python para uma pequena
biblioteca C++ simulando uma conta bancária. A dependência pybind11
será satisfeita no momento da configuração usando <code class="docutils literal notranslate"><span class="pre">FetchContent</span></code>.</p>
<p>O projeto base está em <code class="docutils literal notranslate"><span class="pre">source/code/day-2/27_cxx-pybind11</span></code>.
A estrutura da pasta é a seguinte:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>27_cxx-pybind11
└── account
    ├── account.cpp
    ├── account.hpp
    └── test.py
</pre></div>
</div>
<ol class="arabic">
<li><p>Crie um <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> na raiz do programa, com
requisito e projeto mínimo do CMake.</p></li>
<li><p>Encontre o Python com <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/find_package.html"><span class="xref std std-term"><code class="docutils literal notranslate">find_package</code></span></a>. Solicite pelo menos a versão
3.6 com a palavra-chave <code class="docutils literal notranslate"><span class="pre">REQUIRED</span></code> e o interpretador e
os cabeçalhos de desenvolvimento com a palavra-chave
<code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>. Consulte a documentação:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cmake --help-module FindPython <span class="p">|</span> less
</pre></div>
</div>
</li>
<li><p>Habilite o teste e adicione a pasta <code class="docutils literal notranslate"><span class="pre">account</span></code>.</p></li>
<li><p>Preencha o <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> base na pasta <code class="docutils literal notranslate"><span class="pre">account</span></code>,
seguindo os prompts do <code class="docutils literal notranslate"><span class="pre">FIXME</span></code>. Queremos baixar o tarball
lançado para a versão 2.6.2 do pybind11.</p></li>
<li><p>Configure, construa e execute o teste.</p></li>
</ol>
</div></blockquote>
<p>Uma solução funcional está na subpasta <code class="docutils literal notranslate"><span class="pre">solution</span></code>.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>A função <code class="docutils literal notranslate"><span class="pre">pybind11_add_module</span></code> é um wrapper de conveniência para <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_library.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_library</code></span></a> para
gerar módulos de extensão Python. É oferecido por pybind11 e você
pode ler mais sobre isso <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/compiling.html#pybind11-add-module">aqui</a>.</p></li>
<li><p>A sintaxe especial usada na definição do comando test definirá o local da
extensão Python como uma variável de ambiente.</p></li>
</ul>
</div>
</div></blockquote>
</div>
</section>
<section id="misturando-c-fortran-e-python-com-cffi">
<h2>Misturando C/Fortran e Python com CFFI<a class="headerlink" href="#misturando-c-fortran-e-python-com-cffi" title="Permalink to this headline"></a></h2>
<p><a class="reference external" href="https://cffi.readthedocs.io/en/latest/index.html">CFFI</a>, abreviação de “C Foreign Function Interface”, é um módulo Python que
ajuda na criação de interfaces Python para projetos C-interoperáveis.
Usar CFFI pode ser um pouco mais simples do que trabalhar com pybind11.
No entanto, ele permite que você crie interfaces Python para projetos
Fortran de forma mais direta do que com Cython ou SWIG.
Isso requer alguns passos:</p>
<ol class="arabic simple">
<li><p>escrever um arquivo de cabeçalho C definindo a
interface de programação de aplicativos (API) do seu código.</p></li>
<li><p>invocando CFFI para analisar o arquivo de cabeçalho da API e
produzir o código de wrapper C correspondente.</p></li>
<li><p>compilando o código wrapper gerado em um módulo Python.</p></li>
</ol>
<p>Embora a etapa 1 dependa do código para o qual você deseja fornecer o
código de vinculações do Python, as etapas 2 e 3 podem ser automatizadas
em um sistema de compilação CMake.</p>
<div class="admonition-exercicio-28-codigo-bancario-usando-cffi exercise important admonition" id="exercise-1">
<p class="admonition-title">Exercício 28: Código bancário usando CFFI</p>
<p>Nosso objetivo é compilar wrappers Python para uma pequena biblioteca simulando uma conta bancária.
O código de exemplo já tem um arquivo de cabeçalho da API.
Este exercício mostrará como realizar as etapas 2 e 3 acima:</p>
<ul>
<li><dl class="simple">
<dt>O script Python <code class="docutils literal notranslate"><span class="pre">cffi_builder.py</span></code> analisa o arquivo de cabeçalho da</dt><dd><p>API e irá gerar o arquivo fonte <code class="docutils literal notranslate"><span class="pre">_pyaccount.c</span></code> no
<em>tempo de compilação</em>. Conseguimos isso no CMake usando um
comando personalizado, emparelhado com um destino personalizado.</p>
</dd>
</dl>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_custom_command</span><span class="p">(</span>
<span class="w">  </span><span class="s">OUTPUT</span>
<span class="w">    </span><span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/generated/_pyaccount.c</span>
<span class="w">  </span><span class="s">COMMAND</span>
<span class="w">    </span><span class="o">${</span><span class="nv">Python_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/cffi_builder.py</span>
<span class="w">  </span><span class="s">MAIN_DEPENDENCY</span>
<span class="w">    </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/cffi_builder.py</span>
<span class="w">  </span><span class="s">DEPENDS</span>
<span class="w">    </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/account.h</span>
<span class="w">  </span><span class="s">WORKING_DIRECTORY</span>
<span class="w">    </span><span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/generated</span>
<span class="w">  </span><span class="p">)</span>

<span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">  </span><span class="s">pyaccount-builder</span>
<span class="w">  </span><span class="s">ALL</span>
<span class="w">  </span><span class="s">DEPENDS</span>
<span class="w">    </span><span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/generated/_pyaccount.c</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>Isso garante que o arquivo seja regenerado sempre que o cabeçalho da API for alterado.</p>
<ul>
<li><dl class="simple">
<dt>Uma vez que o <code class="docutils literal notranslate"><span class="pre">_pyaccount.c</span></code> esteja disponível, nós o construímos</dt><dd><p>como um módulo Python, usando a função <code class="docutils literal notranslate"><span class="pre">Python_add_library</span></code>,
fornecida no módulo <code class="docutils literal notranslate"><span class="pre">FindPython</span></code> do CMake.</p>
</dd>
</dl>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">Python_add_library</span><span class="p">(</span><span class="s">_pyaccount</span>
<span class="w">  </span><span class="s">MODULE</span>
<span class="w">    </span><span class="s">account.f90</span>
<span class="w">    </span><span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/generated/_pyaccount.c</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># add dependency between _pyaccount target and pyaccount-builder custom target</span>
<span class="w">  </span><span class="nb">add_dependencies</span><span class="p">(</span><span class="s">_pyaccount</span><span class="w"> </span><span class="s">pyaccount-builder</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">Fortran</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><blockquote>
<div><p>Um projeto base está em <code class="docutils literal notranslate"><span class="pre">source/code/day-2/28_fortran-cffi</span></code>.
A estrutura do código é a seguinte:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>28_fortran-cffi/
├── account
│   ├── account.f90
│   ├── account.h
│   ├── cffi_builder.py
│   ├── CMakeLists.txt
│   ├── __init__.py
│   └── test.py
└── CMakeLists.txt
</pre></div>
</div>
<p>Siga os prompts do <code class="docutils literal notranslate"><span class="pre">FIXME</span></code> em <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> para fazer o projeto compilar.</p>
<ol class="arabic">
<li><p>Declare um projeto usando C e Fortran.</p></li>
<li><p>Encontre o Python com <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/find_package.html"><span class="xref std std-term"><code class="docutils literal notranslate">find_package</code></span></a>.
Solicite pelo menos a versão 3.6 com a palavra-chave
<code class="docutils literal notranslate"><span class="pre">REQUIRED</span></code> e o interpretador e os cabeçalhos de
desenvolvimento com a palavra-chave <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>.
Consulte a documentação:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cmake --help-module FindPython <span class="p">|</span> less
</pre></div>
</div>
</li>
<li><p>Adicione a pasta <code class="docutils literal notranslate"><span class="pre">account</span></code> e ative o teste.</p></li>
<li><p>Preencha <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> na pasta <code class="docutils literal notranslate"><span class="pre">account</span></code>, seguindo os prompts do <code class="docutils literal notranslate"><span class="pre">FIXME</span></code>.</p></li>
<li><p>Configure, construa e execute o teste.</p></li>
</ol>
</div></blockquote>
<p>Uma solução funcional está na subpasta <code class="docutils literal notranslate"><span class="pre">solution</span></code>.</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>Um projeto base está em  <code class="docutils literal notranslate"><span class="pre">content/code/day-2/28_cxx-cffi</span></code>.
A estrutura do código é a seguinte:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>28_fortran-cffi/
├── account
│   ├── account.cpp
│   ├── account.hpp
│   ├── c_cpp_interface.cpp
│   ├── account.h
│   ├── cffi_builder.py
│   ├── CMakeLists.txt
│   ├── __init__.py
│   └── test.py
└── CMakeLists.txt
</pre></div>
</div>
<ol class="arabic">
<li><p>Declare o projeto C++.</p></li>
<li><p>FEncontre o Python com <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/find_package.html"><span class="xref std std-term"><code class="docutils literal notranslate">find_package</code></span></a>.
Solicite pelo menos a versão 3.6 com a palavra-chave
<code class="docutils literal notranslate"><span class="pre">REQUIRED</span></code> e o interpretador e os cabeçalhos de
desenvolvimento com a palavra-chave <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>.
Consulte a documentação:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cmake --help-module FindPython <span class="p">|</span> less
</pre></div>
</div>
</li>
<li><p>Adicione a pasta <code class="docutils literal notranslate"><span class="pre">account</span></code> e ative o teste.</p></li>
<li><p>Preencha <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> na pasta <code class="docutils literal notranslate"><span class="pre">account</span></code>, seguindo os prompts do <code class="docutils literal notranslate"><span class="pre">FIXME</span></code>.</p></li>
<li><p>Configure, construa e execute o teste.</p></li>
</ol>
<p>A estrutura do código é a seguinte:</p>
</div></div>
</div>
<div class="admonition-resumo keypoints admonition" id="keypoints-0">
<p class="admonition-title">Resumo</p>
<ul class="simple">
<li><p>O CMake pode simplificar o sistema de compilação para projetos complexos e multilíngues.</p></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fetch-content.html" class="btn btn-neutral float-left" title="A08 - Manipulação de dependência automatizada com FetchContent" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="quick-reference.html" class="btn btn-neutral float-right" title="Referência rápida" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Jose J. Camata.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>